---
title: "A sparklyr extension for Hail"
output:
  github_document:
    fig_width: 9
    fig_height: 5
---

## Installation

```{r eval=FALSE}
install.packages("devtools")
devtools::install_github("samuelmacedo83/sparkhail")
```

## Read a matrix table

```{r read_matrix}
library(sparkhail)
library(sparklyr)

sc <- spark_connect(master = "local", version = "2.4", config = hail_config())

hl <- hail_context(sc)
mt <- hail_read_matrix(hl, system.file("data/1kg.mt", package = "sparkhail"))
```

## Describe

You can take the information about the matrix table separately using `mt_globals_fields()`, `mt_col_fields()`, `mt_row_fields()`, `mt_entry_fields()`, `mt_col_key()` and `mt_row_key()`.
Or you can use `describe()`. 

```{r}
hail_describe(mt)
```

## Data Frame

Convert to spark Data Frame as follows

```{r}
df <- hail_dataframe(mt)
df
```

## Data Frame manipulation

Now that we convert a matrix table in a spark dataframe, we can manipulate our data using `select`, `filter`, `group_by` and so on.

```{r message=FALSE}
library(dplyr)

df %>% 
  sdf_separate_column("alleles") %>% 
  filter(alleles_1 %in% c("G", "T")) %>% 
  select(locus, alleles_1, alleles_2, qual, entries)
```

You can access nested data using the `sparklyr.nested` package.

```{r}
library(sparklyr.nested)

df %>% 
  sdf_select(locus,alleles, DP = info.DP)

```

## Cleanup

Then disconenct from Spark and Hail,

```{r}
spark_disconnect(sc)
```
